# This script includes workflow for quantifying differences in niche between lineages of
# the Anolis distichus species group.
## Authors: Tanner C. Myers, Pietro L. H. de Mello, Paul M. Hime, and Richard E. Glor

# Load R packages and functions
``` {r}

rm(list = ls())

# Set working directory
working_dir <- getwd()
setwd(working_dir)

# Load libraries
library(spocc)
library(terra)
library(tidyterra)
library(sf)
library(sp)
library(rmapshaper)
library(ellipsenm)
library(rangeBuilder)
library(ENMTools)
library(data.table)
library(tidyverse)

# Load functions
source("scripts/fill.NA.r")
```

```{r}
# Load shapefile of Hispaniola for masking rasters
hispaniola <- st_read(dsn = paste0(working_dir, "/data/shape-files/")) # or
# hispaniola <- vect(paste0(working_dir, "/data/shape-files/Hispaniola.shp"))
```

# Download occurrences
```{r}
# Create directory where you want unfiltered occurrences to go
occ_dir <- paste0(working_dir, "/data/occurrences/")
# dir.create(occ_dir)

# Get occurrences for Anolis distichus and Anolis brevirostris from GBIF, VertNet, and iNaturalist
ad <- spocc::occ(query = c("Anolis distichus", "Anolis dominicensis",
                "Anolis ignigularis", "Anolis properus", "Anolis favillarum",
                "Anolis ravitergum", "Anolis vinosus", "Anolis aurifer", "Anolis suppar"),
                from = c("vertnet", "gbif", "inat"), limit = 100000)

## Combine all dataframes into one large dataframe
gbif_occs <- bind_rows(ad$gbif$data, .id = "column_label")

## Repeat for iNaturalist and VertNet occurrences
inat_occs <- bind_rows(ad$inat$data, .id = "column_label")
vertnet_occs <- bind_rows(ad$vertnet$data, .id = "column_label")

for (i in unique(gbif$datasetKey)){
        print(paste("Occurrence count for", i, "is", dim(gbif[gbif$datasetKey == i,])[1]))
}

## Write unfiltered occurrences from the databases to files
write_csv(gbif_occs, "Anolis_distichus_GBIF_occurrences_download.csv")
write_csv(vertnet_occs, "Anolis_distichus_VertNet_occurrences_download.csv")
write_csv(inat_occs, "Anolis_distichus_iNat_occurrences_download.csv")

## Create master files of occurrences
colnames(gbif_occs)
# This will work for both species' sets of occurrences
columns <- c("name", "longitude", "latitude", "year", "month", "day")

occs <- as_tibble(rbind(gbif_occs[, columns], vertnet_occs[, columns]))

## For iNaturalist occurrences only (naming conventions differ)
## First, filter out non-research grade, obscured, and private observations
inat_occs <- inat_occs[inat_occs$quality_grade == "research", ]
inat_occs <- inat_occs %>% filter(!geoprivacy %in% c("obscured", "private"))
colnames(inat_occs)
columns2 <- c("name", "longitude", "latitude", "observed_on_details.year", "observed_on_details.month", "observed_on_details.day")
inat_occs_filtered <- inat_occs[, columns2]
colnames(inat_occs_filtered) <- columns 

occs <- as_tibble(rbind(occs, inat_occs_filtered))
write_csv(occs, "unfiltered_distichus_occurrences.csv")
```

# Filter occurrences
```{r}
# Load occurrences if not already loaded
# occs <- read_csv(paste0(occ_dir, "unfiltered_distichus_occurrences.csv"))

# Exclude occurrences without coordinates
occs <- occs %>% filter_at(vars(longitude, latitude), all_vars(!is.na(.)))

# Exclude duplicate occurrences
occs <- occs[!duplicated(paste(occs$longitude, occs$latitude)), ]

# Omit samples not from Hispaniola
## Get extent for cropping
limits <- ext(hispaniola)

## Convert sampling coordinates into SpatVector
pts <- vect(as.matrix(occs[, c("longitude", "latitude")]), type = "points")
## Crop it!
pts2 <- crop(x = pts, y = limits)
# plot(pts2)
pts2 <- as.data.frame(terra::geom(pts2)[, 3:4])
colnames(pts2) <- c("longitude", "latitude")

occs <- right_join(x = occs, y = pts2)

# There are still some pesky ocean-dwelling anoles,
# but those will get cleaned up when we split this dataset into different lineages
write_csv(occs, paste0(occ_dir, "filtered_distichus_occurrences.csv"))

# Load filtered occurrences downloaded with `spocc` R package
occs <- read_csv(paste0(occ_dir, "filtered_distichus_occurrences.csv"))
all_pts <- vect(as.matrix(occs[, 2:3]), type = "points")

all_pts <- mask(x = all_pts, mask = vect(hispaniola))
```

# Load sampling information and population clustering assignment from ddRADseq data
```{r}
# Load ddRAD sampling spreadsheet
RAD_data <- read_table("~/Dropbox/Distichus_Project/ddRADseq_Phylogeography/info/distichus-species-group-Hispaniola-only-popmap-cleaned.tsv", col_names = FALSE) 
colnames(RAD_data) <- c("specimen", "specimen_pop", "filepath", "subspecies", "population", "complex", "island", "locality", "longitude", "latitude", "note")
K5_geno <- read_table("~/Dropbox/Distichus_Project/ddRADseq_Phylogeography/AnoDist_aln/population-structure/ADMIXTURE_PCA/geno90/distichus_geno90_filtered_LD_50kb_100_0.1_ready.5.Q", col_names = FALSE)
cluster <- apply(K5_geno, 1, which.max)

RAD_data <- as_tibble(cbind(RAD_data, cluster))
## Remove duplicates
RAD_data <- as_tibble(unique(setDT(RAD_data), by = 'locality'))
```

# Generate range polygons
```{r}
## K = 1 includes three distinct genomic clusters recovered by hierarchical analysis
for (k in 2:5){
    pts <- SpatialPoints(RAD_data[RAD_data$cluster == k, c("longitude", "latitude")])
        crs(pts) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
        assign(paste0("K", k, "_pts"), pts)

    poly <- rangeBuilder::getDynamicAlphaHull(x = pts@coords, fraction = 1.0, clipToCoast = "terrestrial", buff = 1000)
    poly <- vect(poly[[1]])
        assign(paste0("K", k, "_alpha_poly"), poly)
}

# Western A. d. dominicensis
dom14_pts <- SpatialPoints(RAD_data[(RAD_data$subspecies == "dom1"| RAD_data$subspecies == "dom4"), c("longitude", "latitude")])
## larger buffer because sampling includes fewest amount of range
dom14_poly <- rangeBuilder::getDynamicAlphaHull(x = dom14_pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial", buff = 40000)
dom14_poly <- vect(dom14_poly[[1]])

## Tiburon peninsula endemic subspecies 
## Updated to include sampling from greater area
tiburon_pts <- data.frame(rbind(occs[occs$name %in% c( "Anolis distichus aurifer Schwartz, 1968", "Anolis distichus aurifer", "Anolis distichus eurifer",
                        "Anolis distichus vinosus", "Anolis distichus vinosus Schwartz, 1968",
                        "Anolis vinosus", "ANOLIS DISTICHUS VINOSUS", "Anolis vinosus Schwartz, 1968",
                        "Anolis distichus suppar", "Anolis distichus suppar Schwartz, 1968"), 2:3],
                        RAD_data[RAD_data$subspecies %in% c("aurifer", "dom3", "suppar", "vinosus"), c("longitude", "latitude")]))
tiburon_pts <- tiburon_pts[tiburon_pts$latitude < 19,]
tiburon_pts <- SpatialPoints(tiburon_pts)
tiburon_poly <- rangeBuilder::getDynamicAlphaHull(x = tiburon_pts@coords, fraction = 1.0, clipToCoast = "no", buff = 1000, verbose = TRUE)
tiburon_poly <- vect(tiburon_poly[[1]])   

## A. d. favillarum (by far the smallest range)
fav_pts <- SpatialPoints(RAD_data[RAD_data$subspecies %in% c("favillarum") & RAD_data$cluster == 1, c("longitude", "latitude")])
fav_poly <- rangeBuilder::getDynamicAlphaHull(x = fav_pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial", buff = 1000)
fav_poly <- vect(fav_poly[[1]])

ggplot() + geom_sf(data = hispaniola) +
    geom_spatvector(data = K2_alpha_poly) + geom_spatvector(data = K3_alpha_poly) + geom_spatvector(data = K4_alpha_poly) + geom_spatvector(data = K5_alpha_poly) +
    geom_spatvector(data = dom14_poly) + geom_spatvector(data = fav_poly) + geom_spatvector(data = tiburon_poly)
## ignigularis + properus overlap, western and eastern dominicensis overlap, and so do ignigularis and eastern dominicensis
```

# Crop and remove overlapping sections of polygons prior to filtering occurences
```{r}
## ignigularis + properus 
crop <- crop(K5_alpha_poly, K4_alpha_poly)
K5_alpha_poly <- erase(K5_alpha_poly, crop)

## western and eastern dominicensis
crop <- crop(dom14_poly, K2_alpha_poly)
dom14_poly <- erase(dom14_poly, crop)

## ignigularis and eastern dominicensis
crop <- crop(K5_alpha_poly, K2_alpha_poly)
K5_alpha_poly <- erase(K5_alpha_poly, crop)

ggplot() + geom_sf(data = hispaniola) + geom_spatvector(data = K2_alpha_poly, col = "brown") + geom_spatvector(data = K4_alpha_poly, col = "gray10") + geom_spatvector(data = K5_alpha_poly, col = "orangered") + geom_spatvector(data = dom14_poly, col = "tan")


dir.create("niche-assessment/ranges")
ranges <- mget(ls(pattern = "_poly"))

lapply(names(ranges), function (x) {
        writeVector(ranges[[x]], filename = paste0("niche-assessment/ranges/", x, ".shp"), overwrite = TRUE, filetype = "ESRI Shapefile")
})
```

# Filter points based on polygons and thin
```{r}
# Prepare all points for masking/thinning
all_pts <- geom(all_pts)[, 3:4]
colnames(all_pts) <- colnames(RAD_data[, c("longitude", "latitude")])
all_pts <- vect(as.matrix(rbind(all_pts, RAD_data[, c("longitude", "latitude")])))

## Function to mask and thin points ## Need to fix: (1) save total points to object, (2) write objects, (3) preserve object names/change names in resulting object?
pt_thinner <- function(poly){
    # Mask occurrences to include only those within polygon
    masked <- terra::mask(x = all_pts, mask = poly)
    # Convert from SpatVector to dataframe 
    df <- as.data.frame(terra::geom(masked)[, 3:4])

    df2 <- df[!duplicated(paste(df$x, df$y)), ]
    colnames(df2) <- c("longitude", "latitude")

    if (ext(poly) == ext(ranges$fav_poly)){
        df3 <- thin_data(df2, "longitude", "latitude", thin_distance = 2, save = FALSE) 
    } else {
        df3 <- thin_data(df2, "longitude", "latitude", thin_distance = 10, save = FALSE)      
    }

    output <- list("total_pts" = df2, "thinned_pts" = df3)

    return(output)
}

range_pts <- lapply(ranges, pt_thinner)

ggplot() + geom_sf(data = hispaniola) +
    geom_spatvector(data = ranges$K2_alpha_poly) + geom_spatvector(data = ranges$K3_alpha_poly) + geom_spatvector(data = ranges$K4_alpha_poly) + geom_spatvector(data = ranges$K5_alpha_poly) +
    geom_spatvector(data = ranges$dom14_poly) + geom_spatvector(data = ranges$fav_poly) + geom_spatvector(data = ranges$tiburon_poly) +
    geom_point(data = range_pts$K2_alpha_poly$thinned_pts, aes(x = longitude, y = latitude), color = "brown") + geom_point(data = range_pts$K3_alpha_poly$thinned_pts, aes(x = longitude, y = latitude), color = "yellow") +
    geom_point(data = range_pts$K4_alpha_poly$thinned_pts, aes(x = longitude, y = latitude), color = "gray60") + geom_point(data = range_pts$K5_alpha_poly$thinned_pts, aes(x = longitude, y = latitude), color = "orangered") +
    geom_point(data = range_pts$dom14_poly$thinned_pts, aes(x = longitude, y = latitude), color = "tan") + geom_point(data = range_pts$tiburon_poly$thinned_pts, aes(x = longitude, y = latitude), color = "dodgerblue3") +
    geom_point(data = range_pts$fav_poly$thinned_pts, aes(x = longitude, y = latitude), color = "orchid")

lapply(names(range_pts), function(x) {
        write_csv(range_pts[[x]]$total_pts, paste0(working_dir, "/niche-assessment/", x, "-total-points.csv"))
        write_csv(range_pts[[x]]$thinned_pts, paste0(working_dir, "/niche-assessment/", x, "-thinned-points.csv"))
})
```

# Generate range polygons, presence points, and rasters for generating background points
```{r}
for (k in 1:5){
    pts <- SpatialPoints(RAD_data[RAD_data$cluster == k, c("longitude", "latitude")])
        crs(pts) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

    poly <- rangeBuilder::getDynamicAlphaHull(x = pts@coords, fraction = 1.0, clipToCoast = "terrestrial", buff = 1000)
    poly <- vect(poly[[1]])
        assign(paste0("K", k, "_alpha_poly"), poly)
    
    ## Subset occurrences that fall within spatial polygon made above
    masked <- terra::mask(x = all_pts, mask = poly)
    df <- as.data.frame(terra::geom(masked)[, 3:4])

    # Combine total points
    colnames(df) <- colnames(pts@coords)
    df2 <- as_tibble(rbind(pts@coords, df))
    df3 <- as_tibble(as.data.frame(cbind(df2, rep(k, nrow(df2)))))
        colnames(df3)[3] <- "cluster"
        df3$cluster <- as.factor(df3$cluster)
        df3 <- df3[!duplicated(paste(df3$longitude, df3$latitude)), ]
    write_delim(x = df3, file = paste0("niche-assessment/", "K_", k, "_total_pts.csv"),
                delim = ",", col_names = TRUE)
        assign(paste0("K", k, "_total_pts"), df3)
    
    ## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 10, save = FALSE)
        write_delim(x = df4, file = paste0("niche-assessment/", "K_", k, "_thinned.csv"), delim = ",", col_names = TRUE)
        assign(paste0("K", k, "_thinned"), df4)
}

# ADMIXTURE groups A. d. dominicensis west of the Cordillera Central and the South paleo-island populations together
# however, phylogenies disagree with this so we are going to split that cluster into these distinct geographic groups:
# western A. d. dominicensis
dom14_pts <- SpatialPoints(RAD_data[(RAD_data$subspecies == "dom1"| RAD_data$subspecies == "dom4"), c("longitude", "latitude")])
## larger buffer because sampling includes fewest amount of range
dom14_poly <- rangeBuilder::getDynamicAlphaHull(x = dom14_pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial", buff = 40000)
dom14_poly <- vect(dom14_poly[[1]])
crop <- crop(dom14_poly, K2_alpha_poly)
dom14_poly <- terra::erase(dom14_poly, crop)

masked <- terra::mask(x = all_pts, mask = dom14_poly)
    df <- as.data.frame(terra::geom(masked)[, 3:4])
    # Combine total points
    colnames(df) <- colnames(dom14_pts@coords)
    df2 <- as_tibble(rbind(dom14_pts@coords, df))
    df3 <- as_tibble(as.data.frame(cbind(df2, rep("dom14", nrow(df2)))))
    colnames(df3)[3] <- "cluster"
    write_delim(x = df3, file = "niche-assessment/dom14_total_pts.csv",
                delim = ",", col_names = TRUE)
## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 10, save = FALSE)
        write_delim(x = df4, file = "niche-assessment/dom14_thinned.csv", delim = ",", col_names = TRUE)
dom14 <- read_csv("niche-assessment/dom14_thinned.csv")

## Tiburon peninsula endemic subspecies 
## Updated to include sampling from greater area
tiburon_pts <- data.frame(rbind(occs[occs$name %in% c( "Anolis distichus aurifer Schwartz, 1968", "Anolis distichus aurifer", "Anolis distichus eurifer",
                        "Anolis distichus vinosus", "Anolis distichus vinosus Schwartz, 1968",
                        "Anolis vinosus", "ANOLIS DISTICHUS VINOSUS", "Anolis vinosus Schwartz, 1968",
                        "Anolis distichus suppar", "Anolis distichus suppar Schwartz, 1968"), 2:3],
                        RAD_data[RAD_data$subspecies %in% c("aurifer", "dom3", "suppar", "vinosus"), c("longitude", "latitude")] 
))
tiburon_pts <- tiburon_pts[tiburon_pts$latitude < 19,]
tiburon_pts <- SpatialPoints(tiburon_pts)
tiburon_poly <- rangeBuilder::getDynamicAlphaHull(x = tiburon_pts@coords, fraction = 1.0, clipToCoast = "no", buff = 1000, verbose = TRUE)
tiburon_poly <- vect(tiburon_poly[[1]])                
masked <- terra::mask(x = all_pts, mask = tiburon_poly)
    df <- as.data.frame(terra::geom(masked)[, 3:4])
    # Combine total points
    colnames(df) <- colnames(tiburon_pts@coords)
    df2 <- as_tibble(rbind(tiburon_pts@coords, df))
    df3 <- as_tibble(base::as.data.frame(cbind(df2, rep("Tiburon", nrow(df2)))))
    colnames(df3)[3] <- "cluster"
    write_delim(x = df3, file = "niche-assessment/Tiburon_total_pts.csv", delim = ",", col_names = TRUE)
## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 10, save = FALSE)
        write_delim(x = df4, file = "niche-assessment/Tiburon_thinned.csv", delim = ",", col_names = TRUE)
tiburon <- read_csv("niche-assessment/Tiburon_thinned.csv")

## A. d. favillarum (by far the smallest range)
fav_pts <- SpatialPoints(RAD_data[RAD_data$subspecies %in% c("favillarum") & RAD_data$cluster == 1, c("longitude", "latitude")])
fav_poly <- rangeBuilder::getDynamicAlphaHull(x = fav_pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial", buff = 1000)
fav_poly <- vect(fav_poly[[1]])                
masked <- terra::mask(x = all_pts, mask = fav_poly)
    df <- as.data.frame(terra::geom(masked)[, 3:4])
    # Combine total points
    colnames(df) <- colnames(fav_pts@coords)
    df2 <- as_tibble(rbind(fav_pts@coords, df))
    df3 <- as_tibble(base::as.data.frame(cbind(df2, rep("favillarum", nrow(df2)))))
    colnames(df3)[3] <- "cluster"
    write_delim(x = df3, file = "niche-assessment/fav_total_pts.csv", delim = ",", col_names = TRUE)
## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 1, save = FALSE)
        write_delim(x = df4, file = "niche-assessment/fav_thinned.csv", delim = ",", col_names = TRUE)
fav <- read_csv("niche-assessment/fav_thinned.csv")
```

# Environmental variables
```{r}
env_dir <- "~/Dropbox/Distichus_Project/ddRADseq_Phylogeography/AnoDist_aln/gea/env-data/masked"

## Variables to include only forward-selected environmental variables
ordi_vars <- c("clt_min", "elevation_30sec", "bio4", "bio18", "bio9", "cmi_range", "bio3")

for (var in ordi_vars){
    env <- rast(list.files(path = env_dir, pattern = var, full.names = TRUE))

    ## Because climate and elevational variables were derived from distinct sources,
    ## their extents don't match
    if (var == "elevation_30sec"){
        env <- terra::resample(x = env, y = clt_min)
    }

    assign(var, env)
}

env <- c(clt_min, elevation_30sec, bio4, bio18, bio9, cmi_range, bio3)

crs(env) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

width <- 9
for (i in 1:7){
    var <- terra::focal(env[[i]], w = matrix(1, width, width), fun = fill.na, na.policy = "only")
        assign(paste0("var_", i), var)
}
imp <- env_imputed <- c(var_1, var_2, var_3, var_4, var_5, var_6, var_7)
names(imp) <- names(env)

env <- imp

env <- ENMTools::check.env(env)

# write masked rasters to files
lapply(names(env), function(x) {
    writeRaster(env[[x]], paste0("data/selected-vars/imputed/", x, ".asc"), overwrite = TRUE)
})

env <- rast(list.files(path = "data/selected-vars/imputed", pattern = ".asc$", full.names = TRUE))
```

# Run ENMTools niche assessment tests
# (1) Create ENMTools species objects:
```{r}
## eastern dominicensis
K2 <- enmtools.species(species.name = "K2", presence.points = vect(read.csv("niche-assessment/K2_alpha_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(K2$presence.points) <- crs(env)
    # K2$range <- background.raster.buffer(K2$presence.points, radius = 30000, mask = env[[1]])
    K2$range <- terra::mask(x = env[[1]],  mask = vect("niche-assessment/ranges/K2_alpha_poly.shp"))
    K2$background.points <- background.points.buffer(points = K2$presence.points, radius = 15000, n = 3000, mask = K2$range)
    check.species(K2)

## ravitergum
K3 <- enmtools.species(species.name = "K3", presence.points = vect(read.csv("niche-assessment/K3_alpha_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(K3$presence.points) <- crs(env)
    K3$range <- terra::mask(x = env[[1]],  mask = vect("niche-assessment/ranges/K3_alpha_poly.shp"))
    K3$background.points <- background.points.buffer(points = K3$presence.points, radius = 15000, n = 3000, mask = K3$range)
    check.species(K3)

## properus
K4 <- enmtools.species(species.name = "K4", presence.points = vect(read.csv("niche-assessment/K4_alpha_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(K4$presence.points) <- crs(env)
    K4$range <- terra::mask(x = env[[1]],  mask = vect("niche-assessment/ranges/K4_alpha_poly.shp"))
    K4$background.points <- background.points.buffer(points = K4$presence.points, radius = 15000, n = 3000, mask = K4$range)
    check.species(K4)

## ignigularis
K5 <- enmtools.species(species.name = "K5", presence.points = vect(read.csv("niche-assessment/K5_alpha_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(K5$presence.points) <- crs(env)
    K5$range <- terra::mask(x = env[[1]], mask = vect("niche-assessment/ranges/K5_alpha_poly.shp"))
    K5$background.points <- background.points.buffer(points = K5$presence.points, radius = 15000, n = 3000, mask = K5$range)
    check.species(K5)

west_dom <- enmtools.species(species.name = "western_dominicensis", presence.points = vect(read.csv("niche-assessment/dom14_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(west_dom$presence.points) <- crs(env)
    west_dom$range <- terra::mask(x = env[[1]],  mask = vect("niche-assessment/ranges/dom14_poly.shp"))
    west_dom$background.points <- background.points.buffer(points = west_dom$presence.points, radius = 22000, n = 3000, mask = west_dom$range)
    check.species(west_dom)

tiburon <- enmtools.species(species.name = "tiburon", presence.points = vect(read.csv("niche-assessment/tiburon_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(tiburon$presence.points) <- crs(env)
    # tiburon$range <- terra::mask(x = env[[1]],  mask = vect("niche-assessment/ranges/tiburon_poly.shp"))
    tiburon$range <- background.raster.buffer(tiburon$presence.points, radius = 33000, mask = env[[1]]) 
    tiburon$background.points <- background.points.buffer(points = tiburon$presence.points, radius = 32000, n = 3000, mask = tiburon$range)
    check.species(tiburon)

fav <- enmtools.species(species.name = "favillarum", presence.points = vect(read.csv("niche-assessment/fav_poly-thinned-points.csv"), geom = c("longitude", "latitude")))
    crs(fav$presence.points) <- crs(env)
    fav$range <- terra::mask(x = env[[1]],  mask = vect("niche-assessment/ranges/fav_poly.shp"))
    fav$background.points <- background.points.buffer(points = fav$presence.points, radius = 2000, n = 3000, mask = fav$range)
    check.species(fav)

plot(hispaniola)
plot(K2$range, add =T)
plot(K3$range, add = T)
plot(K4$range, add = T)
plot(K5$range, add = T)
plot(fav$range, add = T)
plot(tiburon$range, add = T)
plot(west_dom$range, add = T)

plot(K2$background.points, col = "brown", add =T)
plot(K3$background.points, col = "gold",add = T)
plot(K4$background.points, col = "gray10", add = T)
plot(K5$background.points, col = "orangered", add = T)
plot(fav$background.points, col = "darkorchid2", add = T)
plot(tiburon$background.points, col = "dodgerblue2", add = T)
plot(west_dom$background.points, col = "tan", add = T)
```

# Perform rangebreak blob tests (Update below)
```{r}
# Eastern A. d. dominicensis vs western A. d. dominicensis and South paleo-island
K1K2.rbb <- rangebreak.blob(species.1 = K1, species.2 = K2, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K1vK2/")
    png("niche-assessment/K_1_2_rbb.png")
        plot(K1K2.rbb)
    dev.off()
    print(summary(K1K2.rbb))
    save(K1K2.rbb, file = "niche-assessment/K1K2.rbb.RData")

## Eastern A. d. dominicensis vs A. d. ignigularis
K1K3.rbb <- rangebreak.blob(species.1 = K1, species.2 = K3, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K1vK3/")
    png("niche-assessment/K_1_3_rbb.png")
        plot(K1K3.rbb)
    dev.off()
    print(summary(K1K3.rbb))
    save(K1K3.rbb, file = "niche-assessment/K1K3.rbb.RData")

# ## A. d. ignigularis vs A. d. properus
K3K5.rbb <- rangebreak.blob(species.1 = K3, species.2 = K5, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K3vK5/")
    png("niche-assessment/K_3_5_rbb.png")
        plot(K3K5.rbb)
    dev.off()
    print(summary(K3K5.rbb))
    save(K3K5.rbb, file = "niche-assessment/K3K5.rbb.RData")

# ## A. d. ignigularis vs A. d. ravitergum
K3K4.rbb <- rangebreak.blob(species.1 = K3, species.2 = K4, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K3vK4/")
    png("niche-assessment/K_3_4_rbb.png")
        plot(K3K4.rbb)
    dev.off()
    print(summary(K3K4.rbb))
    save(K3K4.rbb, file = "niche-assessment/K3K4.rbb.RData")

## A. d. ravitergum vs western A. d. dominicensis and South paleo-island
K4K2.rbb <- rangebreak.blob(species.1 = K4, species.2 = K2, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K4vK2/")
    png("niche-assessment/K_4_2_rbb.png")
        plot(K4K2.rbb)
    dev.off()
    print(summary(K4K2.rbb))
    save(K4K2.rbb, file = "niche-assessment/K4K2.rbb.RData")

## Eastern A. d. dominicensis vs western A. d. dominicensis
K1d14.rbb <- rangebreak.blob(species.1 = K1, species.2 = d14, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K1vsD14/")
    png("niche-assessment/K_4_d14_rbb.png")
        plot(K1d14.rbb)
    dev.off()
    print(summary(K1d14.rbb))
    save(K1d14.rbb, file = "niche-assessment/K1d14.rbb.RData")

## A. d. ravitergum vs South paleo-island 
K4spi.rbb <- rangebreak.blob(species.1 = K4, species.2 = spi, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K4vsSPI/")
    png("niche-assessment/K_4_spi_rbb.png")
        plot(K4spi.rbb)
    dev.off()
    print(summary(K4spi.rbb))
    save(K4spi.rbb, file = "niche-assessment/K4spi.rbb.RData")

## A. d. ravitergum vs western A. d. dominicensis
K4d14.rbb <- rangebreak.blob(species.1 = K4, species.2 = d14, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K4vsD14/")
    png("niche-assessment/K_4_d14_rbb.png")
        plot(K4d14.rbb)
    dev.off()
    print(summary(K4d14.rbb))
    save(K4d14.rbb, file = "niche-assessment/K4d14.rbb.RData")

## South paleo-island vs western A. d. dominicensis
spid14.rbb <- rangebreak.blob(species.1 = spi, species.2 = d14, env = env, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_SPIvsD14/")
    png("niche-assessment/K_4_spi_rbb.png")
        plot(spid14.rbb)
    dev.off()
    print(summary(spid14.rbb))
    save(spid14.rbb, file = "niche-assessment/spid14.rbb.RData")
```

# Perform niche similarity/background tests from Warren et al. (2008)
    ## The background test 
    ## There are two categories: asymmetric and symmetric, which differ by the 
    ## asymmetric test comparing observed and simulated points and the symmetric test
    ## comparing only simulated points
```{r}
K_12_bg <- background.test(species.1 = K1, species.2 = K2, env = env, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_13_bg <- background.test(species.1 = K1, species.2 = K3, env = env, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_24_bg <- background.test(species.1 = K2, species.2 = K4, env = env, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_34_bg <- background.test(species.1 = K3, species.2 = K4, env = env, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_35_bg <- background.test(species.1 = K3, species.2 = K5, env = env, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
```


```{r}
# Perform niche equivalency/identity tests from Warren et al. (2008)
    ## The identity test takes presence points for two species and randomly reassigns them
    ## to each species, builds ENMs for these randomized occurrences, and, through many reps,
    ## estimates a probability distribution for ENM overlap between species under null hypothesis
    ## that species' occurrences are randomly drawn from same distribution.

K_12_id <- identity.test(species.1 = K1, species.2 = K2, nreps = 100, env = env2, type = "mx")
K_13_id <- identity.test(species.1 = K1, species.2 = K3, nreps = 100, env = env2, type = "mx")
K_24_id <- identity.test(species.1 = K2, species.2 = K4, nreps = 100, env = env2, type = "mx")
K_34_id <- identity.test(species.1 = K3, species.2 = K4, nreps = 100, env = env2, type = "mx")
K_35_id <- identity.test(species.1 = K3, species.2 = K5, nreps = 100, env = env2, type = "mx")
```