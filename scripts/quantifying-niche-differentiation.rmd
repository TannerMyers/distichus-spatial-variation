# This script includes workflow for quantifying differences in niche between lineages of
# the Anolis distichus species group.
## Authors: Tanner C. Myers, Pietro L. H. de Mello, Paul M. Hime, and Richard E. Glor

# Load R packages and functions
``` {r}

rm(list = ls())

# Set working directory
working_dir <- getwd()
setwd(working_dir)

# Load libraries
library(spocc)
library(sp)
library(raster)
library(rgeos)
library(rgdal)
library(sf)
library(rmapshaper)
library(ellipsenm)
library(envirem)
library(rangeBuilder)
library(fauxcurrence)
library(ENMTools)
library(usdm)
library(RStoolbox)
library(data.table)
library(tidyverse)

# Load functions
source("scripts/fill.NA.r")
```

```{r}
# Load a shapefile of the island of Hispaniola
# DOM <- getData('GADM', country = 'DOM', level=0, path = paste0(working_dir, "/data/shape-files/"), download = FALSE)
# HTI <- getData('GADM', country = 'HTI', level=0, path = paste0(working_dir, "/data/shape-files/"), download = FALSE)
#     row.names(DOM) <- paste("DOM", row.names(DOM), sep = "_")
#     row.names(HTI) <- paste("HTI", row.names(HTI), sep = "_")
# Hispaniola <- rbind(HTI, DOM, makeUniqueIDs = TRUE)
#     Hispaniola <- gSimplify(Hispaniola, tol = 0.01, topologyPreserve = TRUE)
#     ## Remove Gonave, Tortuga, and Saona
#     Hispaniola <- ms_filter_islands(Hispaniola, min_area = 1500000000)
# shapefile(x = Hispaniola, file = paste0(working_dir, "/data/shape-files/Hispaniola.shp")
Hispaniola <- readOGR(paste0(working_dir, "/data/shape-files/Hispaniola.shp"))
```

# Download occurrences
```{r}
# Create directory where you want unfiltered occurrences to go
occ_dir <- paste0(working_dir, "/data/occurrences/")
# dir.create(occ_dir)

# Get occurrences for Anolis distichus and Anolis brevirostris from GBIF, VertNet, and iNaturalist
# ad <- spocc::occ(query = c("Anolis distichus", "Anolis dominicensis",
#     "Anolis ignigularis", "Anolis properus", "Anolis favillarum",
#     "Anolis ravitergum", "Anolis vinosus", "Anolis aurifer", "Anolis suppar"),
#     from = c("vertnet", "gbif", "inat"),
#     limit = 100000)

# ab <- spocc::occ(query = c("Anolis brevirostris"),
#     from = c("vertnet", "gbif", "inat"),
#     limit = 100000)

# ## Get list of dataframes containing occurrences under different taxon labels from GBIF 
#     gbif_occs_ad <- ad$gbif$data
#     gbif_occs_ab <- ab$gbif$data
#     # Combine all dataframes into one large dataframe
#     gbif_occs_ad <- bind_rows(gbif_occs_ad, .id = "column_label")
#     gbif_occs_ab <- bind_rows(gbif_occs_ab, .id = "column_label")

#     # Repeat for iNaturalist and VertNet occurrences
#     inat_occs_ad <- ad$inat$data
#     inat_occs_ad <- bind_rows(inat_occs_ad, .id = "column_label")
#     inat_occs_ab <- ab$inat$data
#     inat_occs_ab <- bind_rows(inat_occs_ab, .id = "column_label")
#     vertnet_occs_ad <- ad$vertnet$data
#     vertnet_occs_ad <- bind_rows(vertnet_occs_ad, .id = "column_label")
#     vertnet_occs_ab <- ab$vertnet$data
#     vertnet_occs_ab <- bind_rows(vertnet_occs_ab, .id = "column_label")

#     # Write unfiltered occurrences from the databases to files
#     write_csv(gbif_occs_ad, "Anolis_distichus_GBIF_occurrences_download.csv")
#     write_csv(vertnet_occs_ad, "Anolis_distichus_VertNet_occurrences_download.csv")
#     write_csv(inat_occs_ad, "Anolis_distichus_iNat_occurrences_download.csv")
#     write_csv(gbif_occs_ab, "Anolis_brevirostris_GBIF_occurrences_download.csv")
#     write_csv(vertnet_occs_ab, "Anolis_brevirostris_VertNet_occurrences_download.csv")
#     write_csv(inat_occs_ab, "Anolis_brevirostris_iNat_occurrences_download.csv")

# ## Create master files of occurrences
#     colnames(gbif_occs_ad)
#     # This will work for both species' sets of occurrences
#     columns <- c("name", "longitude", "latitude", "year", "month", "day")

#     occs_ad <- as_tibble(rbind(gbif_occs_ad[, columns], vertnet_occs_ad[, columns]))
#     occs_ab <- as_tibble(rbind(gbif_occs_ab[, columns], vertnet_occs_ad[, columns]))

#     # For iNaturalist occurrences only (naming conventions differ)
#     ## First, filter out non-research grade, obscured, and private observations
#     inat_occs_ad <- inat_occs_ad[inat_occs_ad$quality_grade == "research", ]
#     inat_occs_ad <- inat_occs_ad %>% filter(!geoprivacy %in% c("obscured", "private"))
#     inat_occs_ab <- inat_occs_ab[inat_occs_ab$quality_grade == "research", ]
#     inat_occs_ab <- inat_occs_ab %>% filter(!geoprivacy %in% c("obscured", "private"))

#     colnames(inat_occs_ad)
#     columns2 <- c("name", "longitude", "latitude", "observed_on_details.year", "observed_on_details.month", "observed_on_details.day")
#     inat_occs_filtered.ad <- inat_occs_ad[, columns2]
#     inat_occs_filtered.ab <- inat_occs_ab[, columns2]
#     colnames(inat_occs_filtered.ad) <- columns 
#     colnames(inat_occs_filtered.ab) <- columns

# occs_ad <- as_tibble(rbind(occs_ad, inat_occs_filtered.ad))
# occs_ab <- as_tibble(rbind(occs_ab, inat_occs_filtered.ab))
# write_csv(occs_ad, "unfiltered_distichus_occurrences.csv")
# write_csv(occs_ab, "unfiltered_brevirostris_occurrences.csv")
```

# Filter occurrences
```{r}
# Load occurrences if not already loaded
# occs_ad <- read_csv(paste0(occ_dir, "unfiltered_distichus_occurrences.csv"))
# occs_ab <- read_csv(paste0(occ_dir, "unfiltered_distichus_occurrences.csv"))

# # Exclude occurrences without coordinates
# occs_ad <- occs_ad %>% filter_at(vars(longitude, latitude), all_vars(!is.na(.)))

# # Exclude duplicate occurrences
# occs_ad <- occs_ad[!duplicated(paste(occs_ad$longitude, occs_ad$latitude)), ]

# # Omit samples not from Hispaniola
#     ## Get extent for cropping
#     limits <- extent(Hispaniola)

#     ## Convert occurrences object to SpatialPointsDataFrame
#     occs_ad.spdf <- SpatialPointsDataFrame(occs_ad[,c("longitude", "latitude")], occs_ad[,c(1, 4:ncol(occs_ad))])
#     occs_ab.spdf <- SpatialPointsDataFrame(occs_ab[,c("longitude", "latitude")], occs_ab[,c(1, 4:ncol(occs_ab))])
#     ## Crop it!
#     occs_ad.spdf <- raster::crop(occs_ad.spdf, limits)
#     occs_ab.spdf <- raster::crop(occs_ab.spdf, limits)

#     ## Convert back to dataframe --- Probably a better way to do this, but I couldn't think of one or find an alternative
#     occs_ad <- as_tibble(cbind(occs_ad.spdf@data[,1], occs_ad.spdf@coords, occs_ad.spdf@data[,2:ncol(occs_ad.spdf@data)]))
#     occs_ab <- as_tibble(cbind(occs_ab.spdf@data[,1], occs_ab.spdf@coords, occs_ab.spdf@data[,2:ncol(occs_ab.spdf@data)])) 

# # There are still some pesky ocean-dwelling anoles,
# # but those will get cleaned up when we split this dataset into different lineages
# write_csv(occs_ad, paste0(occ_dir, "filtered_distichus_occurrences.csv"))
# write.csv(occs_ab, paste0(occ_dir, "filtered_brevirostris_occurrences.csv"))

# Load filtered occurrences downloaded with `spocc` R package
occs_ad <- read_csv(paste0(occ_dir, "filtered_distichus_occurrences.csv"))
occs_ab <- read_csv(paste0(occ_dir, "filtered_brevirostris_occurrences.csv"))
```

# Load environmental variables
```{r}
# chelsa_clim <- raster::stack(list.files(path = "data/chelsa_new/", pattern = ".asc", full.names = TRUE))
# modis_vi <- raster::stack(list.files(path = "data/MODIS_new/", pattern = ".asc", full.names = TRUE))
# ## These raster stacks have different extents
#     ## Since the extent of modis_vi fits within chelsa_clim's extent, crop chelsa_clim
#     chelsa_clim <- crop(chelsa_clim, modis_vi@extent)
#     chelsa_clim@extent <- raster::alignExtent(chelsa_clim@extent, modis_vi)

## Now, load elevational data that has already been adjusted to the MODIS variable extent
# elev_srtm <- raster("data/elevation_new/SRTM_elevation_1km.asc")

# ## Merge all environmental data layers into single raster stack
# env <- raster::stack(elev_srtm, chelsa_clim, modis_vi, full.names = TRUE)
#     ## Check rasters for same extent and resolution &
#     ## set values to NA if NAs present in any layer
#     env <- crop(env, Hispaniola)
#     crs(env) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
#     env <- ENMTools::check.env(env)

# width <- 9
# for (i in 1:20){
#     var <- terra::focal(env[[i]], w = matrix(1, width, width), fun = fill.na, na.policy = "only")
#         assign(paste0("var_", i), var)
# }

# # Add imputed rasters to a new raster stack
# env_imputed <- stack(var_1, var_2, var_3, var_4, var_5, var_6, var_7, var_8, var_9, var_10, 
#                     var_11, var_12, var_13, var_14, var_15, var_16, var_17, var_18, var_19, var_20)
#     ## Change layer names to original variable names
#     names(env_imputed) <- names(env)
#     env_imputed <- mask(env_imputed, Hispaniola)
#     env_imputed <- ENMTools::check.env(env_imputed)

# # Save imputed variables to a new directory # NOT RUN YET
#     dir.create(paste0(working_dir, "/data/env_imputed"))

#     lapply(names(env_imputed), function(x) {
#         writeRaster(env_imputed[[x]], paste0(working_dir, "/data/env_imputed/", x, ".asc"), overwrite = TRUE)
#     })
env <- raster::stack(list.files(path = "data/env_imputed", pattern = ".asc", full.names = TRUE))
```

# Explore correlation in environmental data & remove collinear variables
```{r}
set.seed(36)

# Examine collinearity among environmental variables
raster.cor.matrix(env)

cor <- raster.cor.plot(env)
    # Plot correlations between raster in MDS space
    png("data/env_imputed/predictor-MDS.png")
        cor$cor.mds.plot
    dev.off()
    # Plot correlations as a heatmap between pairs of rasters
    png("data/env_imputed/predictor-heatmap.png")
        cor$cor.heatmap
    dev.off()

# Estimate Variance Influence Factors (VIFs) for each of the predictors
    ## `vifcor` function of the `usdm` package estimates VIFs for a Raster Stack
    ## by finding a pair of variables with a maximum linear correlation and excludes
    ## the one with the greater VIF until no variable with a high correlation coefficient
    ## with other variables remains
vifcor <- usdm::vifcor(x = env, th = 0.9)
    print(vifcor)

    ## `vifstep` function of the `usdm` package estimates VIFs for a Raster Stack
    ## all at once, excluding the one with the highest VIF, repeating until no variables
    ## with VIF higher than th remains
vifstep <- usdm::vifstep(x = env, th = 10)
    print(vifstep)

# Based on these results, I am going with the following environmental variables:
env2 <- env[[c("CHELSA_bio10_03", "CHELSA_bio10_04",
            "CHELSA_bio10_15", "CHELSA_bio10_16",
            "march_EVI_mean", "may_NDVI_mean")]]
    ENMTools::check.env(env2)
```

# Load sampling information and population clustering assignment from ddRADseq data
```{r}
# Load ddRAD sampling spreadsheet
rad_data <- read_table("~/Dropbox/Distichus_Project/ddRADseq_Phylogeography/info/distichus-popmap-cleaned-master.tsv", col_names = TRUE)
    rad_data[36,2] <- "1352_dom2" ## Note there is a discrepancy in how this specimen is classified between my sampling spreadsheets
cluster <- read_table("~/Dropbox/Distichus_Project/ddRADseq_Phylogeography/population-structure/lea/sNMF/distichus-subsp/sNMF_K5_ancestry_coefficients_cluster-specimen-cleaned.tsv", col_names = TRUE)

rad_data <- rad_data[rad_data$Sample_ID_pop %in% cluster$Sample_ID_pop, ]
    rad_data <- as_tibble(cbind(rad_data, cluster$cluster))
    colnames(rad_data)[13] <- "snmfCluster"
    ## Remove duplicates
    rad_data <- as_tibble(unique(setDT(rad_data), by = 'Locality'))
```

# Generate range polygons, presence points, and rasters for generating background points
```{r}
all_pts <- SpatialPoints(occs_ad[, 2:3])
    crs(all_pts) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
## Get rid of the off-island stragglers
all_pts <- all_pts[!is.na(over(all_pts, Hispaniola)), ]

for (k in 1:5){
    pts <- SpatialPoints(rad_data[rad_data$snmfCluster == k, c("Longitude", "Latitude")])
        crs(pts) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

    poly <- rangeBuilder::getDynamicAlphaHull(x = pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial",
                    buff = 1000)
        assign(paste0("K", k, "_alpha_poly"), poly)

    lims <- extent(poly[[1]])
        assign(paste0("K", k, "_extent"), lims)

    ## Subset occurrences that fall within spatial polygon made above
    df <- all_pts[!is.na(over(all_pts, poly[[1]])), ]
    # Combine total points
    colnames(pts@coords) <- colnames(all_pts@coords)
    df2 <- as_tibble(rbind(pts@coords, df@coords))
    df3 <- as_tibble(base::as.data.frame(cbind(df2, rep(k, nrow(df2)))))
        colnames(df3)[3] <- "K"
        df3$K <- as.factor(df3$K)
        df3 <- df3[!duplicated(paste(df3$longitude, df3$latitude)), ]
    write_delim(x = df3, file = paste0("niche-assessment/", "K_", k, "_total_pts.csv"),
                delim = ",", col_names = TRUE)
        assign(paste0("K", k, "_total_pts"), df3)
    
    ## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 15, save = FALSE)
        write_delim(x = df4, file = paste0("niche-assessment/", "K_", k, "_thinned.csv"), delim = ",", col_names = TRUE)
        assign(paste0("K", k, "_thinned"), df4)
}

# sNMF groups A. d. dominicensis west of the Cordillera Central and the South paleo-island populations together
# however, phylogenies disagree with this so we are going to split that cluster into these distinct geographic groups
# western A. d. dominicensis
dom14_pts <- SpatialPoints(rad_data[rad_data$Taxon == c("dom1", "dom4"), c("Longitude", "Latitude")])
## larger buffer because sampling includes fewest amount of range
dom14_poly <- rangeBuilder::getDynamicAlphaHull(x = dom14_pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial", buff = 40000)
lims <- extent(dom14_poly[[1]])
df <- all_pts[!is.na(over(all_pts, dom14_poly[[1]])), ]
    colnames(dom14_pts@coords) <- colnames(all_pts@coords)
    df2 <- as_tibble(rbind(dom14_pts@coords, df@coords))
    df3 <- as_tibble(base::as.data.frame(cbind(df2, rep(k, nrow(df2)))))
    write_delim(x = df3, file = "niche-assessment/dom14_total_pts.csv",
                delim = ",", col_names = TRUE)
## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 15, save = FALSE)
        write_delim(x = df4, file = "niche-assessment/dom14_thinned.csv", delim = ",", col_names = TRUE)

# South paleo-island
south_pts <- SpatialPoints(rad_data[rad_data$Taxon %in% c("favillarum", "aurifer", "dom3", "suppar", "vinosus") & rad_data$snmfCluster == 2, c("Longitude", "Latitude")])
south_poly <- rangeBuilder::getDynamicAlphaHull(x = south_pts@coords, fraction = 1.0,
                    clipToCoast = "terrestrial", buff = 1000)
lims <- extent(south_poly[[1]])
df <- all_pts[!is.na(over(all_pts, south_poly[[1]])), ]
    colnames(south_pts@coords) <- colnames(all_pts@coords)
    df2 <- as_tibble(rbind(south_pts@coords, df@coords))
    df3 <- as_tibble(base::as.data.frame(cbind(df2, rep("South paleo-island", nrow(df2)))))
    write_delim(x = df3, file = "niche-assessment/south_paleo_total_pts.csv", delim = ",", col_names = TRUE)
## Thin points
    df4 <- thin_data(df3, "longitude", "latitude", thin_distance = 15, save = FALSE)
        write_delim(x = df4, file = "niche-assessment/south_paleo_thinned.csv", delim = ",", col_names = TRUE)
```

# Explore univariate distributions of environmental variables
```{r}
# Merge into one big dataframe
all_pts <- as_tibble(rbind(K1_total_pts, K2_total_pts, K3_total_pts, K4_total_pts, K5_total_pts))
    env_values <- raster::extract(all_pts[, 1:2], x = env)
    all_pts <- na.omit(as_tibble(cbind(all_pts, env_values)))

bio3 <- ggplot(all_pts, aes(x = K, y = CHELSA_bio10_03, fill = K)) +
    geom_violin() +
    scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster I",
        x = "Genetic Clusters (K = 5)",
        y = "Isothermality (BIO3)") +
    theme_classic()
bio3

bio4 <- ggplot(all_pts, aes(x = K, y = CHELSA_bio10_04, fill = K)) +
    geom_violin() +
     scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster I",
        x = "Genetic Clusters (K = 5)",
        y = "Temperature Seasonality (BIO4)") +
    theme_classic()
bio4

bio5 <- ggplot(all_pts, aes(x = K, y = CHELSA_bio10_05, fill = K)) +
    geom_violin() +
     scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster I",
        x = "Genetic Clusters (K = 5)", 
        y = "Mean Daily Max. Temp of Warmest Month (BIO5)") +
    theme_classic()
bio5

bio15 <- ggplot(all_pts, aes(x = K, y = CHELSA_bio10_15, fill = K)) +
    geom_violin() +
     scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster II",
        x = "Genetic Clusters (K = 5)",
        y = "Precipitation Seasonality (BIO15)") +
    theme_classic()
bio15

bio16 <- ggplot(all_pts, aes(x = K, y = CHELSA_bio10_16, fill = K)) +
    geom_violin() +
     scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster II",
        x = "Genetic Clusters (K = 5)",
        y = "Mean Monthly Precipitation Amount of Wettest Quarter (BIO16)") +
    theme_classic()
bio16

marEVI <- ggplot(all_pts, aes(x = K, y = march_EVI_mean, fill = K)) +
    geom_violin() +
     scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster II",
        x = "Genetic Clusters (K = 5)",
        y = "March EVI") +
    theme_classic()
marEVI

mayNDVI <- ggplot(all_pts, aes(x = K, y = may_NDVI_mean, fill = K)) +
    geom_violin() +
     scale_fill_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(title = "Climate Varies by Genetic Cluster II",
        x = "Genetic Clusters (K = 5)",
        y = "May NDVI") +
    theme_classic()
mayNDVI
```

# Perform environmental PCA
```{r}
pca <- prcomp(all_pts[, 4:ncol(all_pts)], scale. = TRUE)
    summary(pca)
pca2 <- as_tibble(data.frame(cbind(all_pts[,1:3], pca$x)))

pc_plot <- ggplot(pca2, aes(PC1, PC2, color = K)) + geom_point(size = 3)
pc_plot <- pc_plot + coord_equal() + stat_ellipse() +
    scale_color_manual(values = c("#634102", "#1a1ac2", "#cf5d34", "#fddc1f","gray80")) +
    labs(x = "PC1 (38.58%)", y = "PC2 (32.09%)") +
    theme_light(base_size = 16)
pc_plot
ggsave("env_pc1-pc2.pdf")

# Do contour plot of principal compoents NOT FINISHED
#test <- ggplot(pca2, aes(PC1, PC2)) + stat_density_2d(aes(fill = clust), geom = "polygon")

# For safe measure, do PCA on rasters themselves
pca_env <- RStoolbox::rasterPCA(env, spca = TRUE)
    # plot pca_env$map
summary(pca_env$model)
# Importance of components:
#                           Comp.1    Comp.2    Comp.3     Comp.4     Comp.5
# Standard deviation     2.6374138 2.4217969 1.7510149 1.41265862 1.12982256
# Proportion of Variance 0.3477976 0.2932550 0.1533027 0.09978022 0.06382495
# Cumulative Proportion  0.3477976 0.6410526 0.7943552 0.89413547 0.95796042
#                            Comp.6      Comp.7      Comp.8      Comp.9
# Standard deviation     0.66859372 0.395721763 0.311149019 0.224127442
# Proportion of Variance 0.02235088 0.007829786 0.004840686 0.002511656
# Cumulative Proportion  0.98031129 0.988141080 0.992981766 0.995493421
#                            Comp.10     Comp.11      Comp.12     Comp.13
# Standard deviation     0.183755922 0.142101776 0.1171059698 0.106767319
# Proportion of Variance 0.001688312 0.001009646 0.0006856904 0.000569963
# Cumulative Proportion  0.997181733 0.998191379 0.9988770693 0.999447032
#                             Comp.14      Comp.15      Comp.16      Comp.17
# Standard deviation     0.0802225538 0.0578716000 2.748685e-02 1.303474e-02
# Proportion of Variance 0.0003217829 0.0001674561 3.777633e-05 8.495227e-06
# Cumulative Proportion  0.9997688153 0.9999362714 9.999740e-01 9.999825e-01
#                             Comp.18      Comp.19      Comp.20
# Standard deviation     1.158269e-02 1.088623e-02 9.822052e-03
# Proportion of Variance 6.707933e-06 5.925504e-06 4.823635e-06
# Cumulative Proportion  9.999893e-01 9.999952e-01 1.000000e+00

knitr::kable(round(pca_env$model$loadings[, 1:5], 5))
# |                   |   Comp.1|   Comp.2|   Comp.3|   Comp.4|   Comp.5|
# |:------------------|--------:|--------:|--------:|--------:|--------:|
# |SRTM_elevation_1km |  0.26928|  0.25862|  0.14115|  0.06832|  0.10597|
# |CHELSA_bio10_01    | -0.27004| -0.27532| -0.10534| -0.02085| -0.09716|
# |CHELSA_bio10_02    |  0.25876|  0.04529| -0.38415| -0.13501| -0.13435|
# |CHELSA_bio10_03    |  0.22154|  0.08965| -0.33440| -0.14061| -0.15920|
# |CHELSA_bio10_04    |  0.12608| -0.09123| -0.40428| -0.24556|  0.10070|
# |CHELSA_bio10_05    | -0.17017| -0.28678| -0.29890| -0.08504| -0.13933|
# |CHELSA_bio10_06    | -0.31372| -0.22495|  0.06633|  0.03513| -0.03031|
# |CHELSA_bio10_07    |  0.25351|  0.01085| -0.40117| -0.13643| -0.10315|
# |CHELSA_bio10_10    | -0.25659| -0.28387| -0.13566| -0.03117| -0.08583|
# |CHELSA_bio10_11    | -0.28029| -0.26791| -0.07416| -0.00077| -0.09819|
# |CHELSA_bio10_12    | -0.17690|  0.26802| -0.24194|  0.27154| -0.09103|
# |CHELSA_bio10_13    | -0.13576|  0.25390| -0.15566|  0.37941| -0.28263|
# |CHELSA_bio10_14    | -0.24477|  0.22153| -0.21881|  0.07405|  0.30397|
# |CHELSA_bio10_15    |  0.19880| -0.11382|  0.19591|  0.14782| -0.59810|
# |CHELSA_bio10_16    | -0.14262|  0.24892| -0.15252|  0.39519| -0.27436|
# |CHELSA_bio10_17    | -0.24614|  0.22208| -0.21516|  0.07368|  0.31101|
# |march_EVI_mean     | -0.24946|  0.22459|  0.06598| -0.31146| -0.05524|
# |march_NDVI_mean    | -0.16967|  0.27535|  0.11522| -0.34843| -0.04275|
# |may_EVI_mean       | -0.21705|  0.21113|  0.03412| -0.33594| -0.29322|
# |may_NDVI_mean      | -0.13553|  0.27044|  0.10093| -0.36147| -0.27689|
```

# Use fauxcurrence package to obtain background points that have been adjusted for spatial sampling bias for Background/niche similarity tests.
```{r}
# Prepare data for fauxcurrence
colnames(all_pts) <- c("x", "y", "species")
all_pts$species <- as.character(all_pts$species)
all_pts$species <- replace(all_pts$species, all_pts$species == 1, "dominicensis")
all_pts$species <- replace(all_pts$species, all_pts$species == 2, "South")
all_pts$species <- replace(all_pts$species, all_pts$species == 3, "ignigularis")
all_pts$species <- replace(all_pts$species, all_pts$species == 4, "ravitergum")
all_pts$species <- replace(all_pts$species, all_pts$species == 5, "properus")

# K_12 <- merge(K1_bias, K2_bias)
# K_13 <- merge(K1_bias, K3_bias)
# K_24 <- merge(K2_bias, K4_bias)
# K_34 <- merge(K3_bias, K4_bias)
# K_35 <- merge(K3_bias, K5_bias)

# Use fauxcurrence to obtain bias-corrected background points
# set.seed(69)
#     # Pairwise between species pairs I will be performing niche similarity tests on
#     coords <- as.data.frame(all_pts[all_pts$species == "dominicensis" | all_pts$species == "South", ])
#     faux_inter_12 <-  fauxcurrence(coords = coords, rast = K_12, inter.spp = TRUE, sep.inter.spp = TRUE)
#         save(faux_inter_12, file = "niche-assessment/faux_inter_12.RData")
        load("niche-assessment/faux_inter_12.RData")

#     coords <- as.data.frame(all_pts[all_pts$species == "dominicensis" | all_pts$species == "ignigularis", ])
#     faux_inter_13 <-  fauxcurrence(coords = coords, rast = K_13, inter.spp = TRUE, sep.inter.spp = TRUE)
#         save(faux_inter_13, file = "niche-assessment/faux_inter_13.RData")
        load("niche-assessment/faux_inter_13.RData")

#     coords <- as.data.frame(all_pts[all_pts$species == "South" | all_pts$species == "ravitergum", ])
#     faux_inter_24 <- fauxcurrence(coords = coords, rast = K_24, inter.spp = TRUE, sep.inter.spp = TRUE)
#         save(faux_inter_24, file = "niche-assessment/faux_inter_24.RData")
        load("niche-assessment/faux_inter_24.RData")
    
#     coords <- as.data.frame(all_pts[all_pts$species == "ignigularis" | all_pts$species == "ravitergum", ])
#     faux_inter_34 <- fauxcurrence(coords = coords, rast = K_34, inter.spp = TRUE, sep.inter.spp = TRUE)
#         save(faux_inter_34, file = "niche-assessment/faux_inter_34.RData")
        load("niche-assessment/faux_inter_34.RData")
        
#     coords <- as.data.frame(all_pts[all_pts$species == "ignigularis" | all_pts$species == "properus", ])     
#     faux_inter_35 <- fauxcurrence(coords = coords, rast = K_35, inter.spp = TRUE, sep.inter.spp = TRUE)
#         save(faux_inter_35, file = "niche-assessment/faux_inter_35.RData")
        load("niche-assessment/faux_inter_35.RData")
```

# Run ENMTools niche assessment tests
# (1) Create ENMTools species objects:
```{r}
K1 <- enmtools.species(species.name = "K1", presence.points = read.csv("niche-assessment/K_1_thinned.csv"))
    K1$range <- background.raster.buffer(K1$presence.points, radius = 50000, mask = env2[[1]])
    K1$background.points <- background.buffer(points = K1$presence.points, buffer.width = 20000, buffer.type = "convhull", return.type = "points", n = 3000, mask = env2[[1]])
    check.species(K1)

K2 <- enmtools.species(species.name = "K2", presence.points = read.csv("niche-assessment/K_2_thinned.csv"))
    K2$range <- background.raster.buffer(K2$presence.points, radius = 50000, mask = env2[[1]])
    K2$background.points <- background.buffer(points = K2$presence.points, buffer.width = 20000, buffer.type = "convhull", return.type = "points", n = 3000, mask = env2[[1]])
    check.species(K2)

K3 <- enmtools.species(species.name = "K3", presence.points = read.csv("niche-assessment/K_3_thinned.csv"))
    K3$range <- background.raster.buffer(K3$presence.points, radius = 50000, mask = env2[[1]])
    K3$background.points <-background.buffer(points = K3$presence.points, buffer.width = 20000, buffer.type = "convhull", return.type = "points", n = 3000, mask = env2[[1]])
    check.species(K3)

K4 <- enmtools.species(species.name = "K4", presence.points = read.csv("niche-assessment/K_4_thinned.csv"))
    K4$range <- background.raster.buffer(K4$presence.points, radius = 50000, mask = env2[[1]])
    K4$background.points <- background.buffer(points = K4$presence.points, buffer.width = 20000, buffer.type = "convhull", return.type = "points", n = 1000, mask = env2[[1]])
    check.species(K4)

K5 <- enmtools.species(species.name = "K5", presence.points = read.csv("niche-assessment/K_5_thinned.csv"))
    K5$range <- background.raster.buffer(K5$presence.points, radius = 50000, mask = env2[[1]])
    K5$background.points <- background.buffer(points = K5$presence.points, buffer.width = 20000, buffer.type = "convhull", return.type = "points", n = 1000, mask = env2[[1]])
    check.species(K5)
```

# Perform rangebreak blob tests
```{r}
# Eastern A. d. dominicensis vs western A. d. dominicensis and South paleo-island
K1K2.rbb <- rangebreak.blob(species.1 = K1, species.2 = K2, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K1vK2/")
    png("niche-assessment/K_1_2_rbb.png")
        plot(K1K2.rbb)
    dev.off()
    print(summary(K1K2.rbb))
    save(K1K2.rbb, file = "niche-assessment/K1K2.rbb.RData")

## Eastern A. d. dominicensis vs A. d. ignigularis
K1K3.rbb <- rangebreak.blob(species.1 = K1, species.2 = K3, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K1vK3/")
    png("niche-assessment/K_1_3_rbb.png")
        plot(K1K3.rbb)
    dev.off()
    print(summary(K1K3.rbb))
    save(K1K3.rbb, file = "niche-assessment/K1K3.rbb.RData")

# ## A. d. ignigularis vs A. d. properus
K3K5.rbb <- rangebreak.blob(species.1 = K3, species.2 = K5, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K3vK5/")
    png("niche-assessment/K_3_5_rbb.png")
        plot(K3K5.rbb)
    dev.off()
    print(summary(K3K5.rbb))
    save(K3K5.rbb, file = "niche-assessment/K3K5.rbb.RData")

# ## A. d. ignigularis vs A. d. ravitergum
K3K4.rbb <- rangebreak.blob(species.1 = K3, species.2 = K4, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K3vK4/")
    png("niche-assessment/K_3_4_rbb.png")
        plot(K3K4.rbb)
    dev.off()
    print(summary(K3K4.rbb))
    save(K3K4.rbb, file = "niche-assessment/K3K4.rbb.RData")

## A. d. ravitergum vs western A. d. dominicensis and South paleo-island
K4K2.rbb <- rangebreak.blob(species.1 = K4, species.2 = K2, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K4vK2/")
    png("niche-assessment/K_4_2_rbb.png")
        plot(K4K2.rbb)
    dev.off()
    print(summary(K4K2.rbb))
    save(K4K2.rbb, file = "niche-assessment/K4K2.rbb.RData")

## Eastern A. d. dominicensis vs western A. d. dominicensis
K1d14.rbb <- rangebreak.blob(species.1 = K1, species.2 = d14, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K1vsD14/")
    png("niche-assessment/K_4_d14_rbb.png")
        plot(K1d14.rbb)
    dev.off()
    print(summary(K1d14.rbb))
    save(K1d14.rbb, file = "niche-assessment/K1d14.rbb.RData")

## A. d. ravitergum vs South paleo-island 
K4spi.rbb <- rangebreak.blob(species.1 = K4, species.2 = spi, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K4vsSPI/")
    png("niche-assessment/K_4_spi_rbb.png")
        plot(K4spi.rbb)
    dev.off()
    print(summary(K4spi.rbb))
    save(K4spi.rbb, file = "niche-assessment/K4spi.rbb.RData")

## A. d. ravitergum vs western A. d. dominicensis
K4d14.rbb <- rangebreak.blob(species.1 = K4, species.2 = d14, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_K4vsD14/")
    png("niche-assessment/K_4_d14_rbb.png")
        plot(K4d14.rbb)
    dev.off()
    print(summary(K4d14.rbb))
    save(K4d14.rbb, file = "niche-assessment/K4d14.rbb.RData")

## South paleo-island vs western A. d. dominicensis
spid14.rbb <- rangebreak.blob(species.1 = spi, species.2 = d14, env = env2, type = "mx", nreps = 1000,
                            bg.source = "points", low.memory = TRUE, verbose = TRUE,
                            rep.dir = "/scratch/tcm0036/distichus-ddRAD/analyses/niche/rangebreak_SPIvsD14/")
    png("niche-assessment/K_4_spi_rbb.png")
        plot(spid14.rbb)
    dev.off()
    print(summary(spid14.rbb))
    save(spid14.rbb, file = "niche-assessment/spid14.rbb.RData")
```

# Perform niche similarity/background tests from Warren et al. (2008)
    ## The background test 
    ## There are two categories: asymmetric and symmetric, which differ by the 
    ## asymmetric test comparing observed and simulated points and the symmetric test
    ## comparing only simulated points
```{r}
K_12_bg <- background.test(species.1 = K1, species.2 = K2, env = env2, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_13_bg <- background.test(species.1 = K1, species.2 = K3, env = env2, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_24_bg <- background.test(species.1 = K2, species.2 = K4, env = env2, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_34_bg <- background.test(species.1 = K3, species.2 = K4, env = env2, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
K_35_bg <- background.test(species.1 = K3, species.2 = K5, env = env2, type = "mx", test.type = "asymmetric", nreps = 100, bg.source = "points")
```


```{r}
# Perform niche equivalency/identity tests from Warren et al. (2008)
    ## The identity test takes presence points for two species and randomly reassigns them
    ## to each species, builds ENMs for these randomized occurrences, and, through many reps,
    ## estimates a probability distribution for ENM overlap between species under null hypothesis
    ## that species' occurrences are randomly drawn from same distribution.

K_12_id <- identity.test(species.1 = K1, species.2 = K2, nreps = 100, env = env2, type = "mx")
K_13_id <- identity.test(species.1 = K1, species.2 = K3, nreps = 100, env = env2, type = "mx")
K_24_id <- identity.test(species.1 = K2, species.2 = K4, nreps = 100, env = env2, type = "mx")
K_34_id <- identity.test(species.1 = K3, species.2 = K4, nreps = 100, env = env2, type = "mx")
K_35_id <- identity.test(species.1 = K3, species.2 = K5, nreps = 100, env = env2, type = "mx")
```